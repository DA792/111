# 定时通知发送功能说明

## 功能概述

系统支持定时扫描待发送的通知，通过**4种方式**（短信、邮件、小程序、服务号）批量发送给所有用户。

---

## 实现架构

### 1. 定时任务类
**文件路径**: `com.scenic.schedule.NotificationScheduleTask`

- **执行频率**: 每5分钟执行一次 (`@Scheduled(cron = "0 */5 * * * ?")`)
- **功能**: 
  - 扫描数据库中所有待发送的通知（`send_status = 0`）
  - 根据通知的接收人类型决定发送范围
  - 批量发送通知给所有用户或指定用户

### 2. 通知发送服务
**文件路径**: `com.scenic.service.system.impl.NotificationServiceImpl`

实现了4种通知发送方式：

#### ① 短信通知 (`sendSmsNotification`)
- **发送条件**: 用户必须绑定手机号
- **实现方式**: 调用短信服务提供商的API（阿里云、腾讯云等）
- **使用场景**: 重要通知、紧急提醒

#### ② 邮件通知 (`sendEmailNotification`)
- **发送条件**: 用户必须绑定邮箱
- **实现方式**: 调用邮件服务提供商的API（JavaMail、阿里云邮件推送等）
- **使用场景**: 详细通知、活动邀请

#### ③ 小程序通知 (`sendMiniappNotification`)
- **发送条件**: 用户必须绑定微信OpenID
- **实现方式**: 调用微信小程序订阅消息API
- **使用场景**: 预约提醒、活动通知

#### ④ 服务号通知 (`sendServiceNotification`)
- **发送条件**: 用户必须关注微信服务号并绑定OpenID
- **实现方式**: 调用微信公众号模板消息API
- **使用场景**: 系统公告、定期通知

---

## 工作流程

```
1. 管理员创建通知
   ↓
2. 通知保存到数据库（send_status = 0，receiver_type = "all"）
   ↓
3. 定时任务每5分钟扫描一次
   ↓
4. 查询所有待发送的通知
   ↓
5. 查询所有启用状态的用户（user_type = 1, status = 1, deleted = 0）
   ↓
6. 根据通知的channel字段，调用对应的发送方法
   ↓
7. 批量发送通知给每个用户
   ↓
8. 更新通知状态（send_status = 1，记录发送时间）
```

---

## 数据库设计

### 通知表 (notification)
```sql
CREATE TABLE notification (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL COMMENT '通知标题',
    content TEXT NOT NULL COMMENT '通知内容',
    channel VARCHAR(50) NOT NULL COMMENT '通知渠道：短信/邮件/小程序/服务号',
    receiver_id BIGINT COMMENT '接收人ID（null表示发送给所有人）',
    receiver_type VARCHAR(50) COMMENT '接收人类型：all-所有人, user-指定用户',
    send_status TINYINT DEFAULT 0 COMMENT '发送状态：0-未发送，1-已发送，2-发送失败',
    send_time DATETIME COMMENT '发送时间',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

## 使用方法

### 1. 创建通知（发送给所有用户）

在管理后台创建通知时，设置：
- `receiver_type = "all"` - 表示发送给所有用户
- `receiver_id = null` - 不指定具体用户
- `channel = "短信"` / `"邮件"` / `"小程序"` / `"服务号"` - 选择发送渠道

### 2. 创建通知（发送给指定用户）

设置：
- `receiver_type = "user"` - 表示发送给指定用户
- `receiver_id = 用户ID` - 指定用户ID
- `channel = "短信"` / `"邮件"` / `"小程序"` / `"服务号"` - 选择发送渠道

---

## 关键代码说明

### 定时任务配置
```java
@Scheduled(cron = "0 */5 * * * ?")  // 每5分钟执行一次
public void sendScheduledNotifications() {
    // 扫描待发送通知并批量发送
}
```

### 批量发送逻辑
```java
private void sendToAllUsers(Notification notification) {
    // 1. 查询所有启用状态的用户
    List<User> allUsers = userMapper.selectAllActiveUsers();
    
    // 2. 遍历用户，逐个发送
    for (User user : allUsers) {
        Notification userNotification = createUserNotification(notification, user);
        notificationService.sendNotificationByChannel(userNotification);
    }
}
```

### 4种发送方式
```java
switch (notification.getChannel()) {
    case "短信":
        return sendSmsNotification(notification);    // 需要用户手机号
    case "邮件":
        return sendEmailNotification(notification);  // 需要用户邮箱
    case "小程序":
        return sendMiniappNotification(notification); // 需要用户OpenID
    case "服务号":
        return sendServiceNotification(notification); // 需要用户OpenID
}
```

---

## 注意事项

### 1. 用户信息要求
- **短信通知**: 用户必须绑定手机号（`user.phone` 不为空）
- **邮件通知**: 用户必须绑定邮箱（`user.email` 不为空）
- **小程序通知**: 用户必须绑定微信OpenID（`user.open_id` 不为空）
- **服务号通知**: 用户必须关注服务号并绑定OpenID

### 2. 发送频率控制
- 定时任务每5分钟执行一次，避免过于频繁
- 批量发送时添加了100ms延迟，避免API调用过于频繁
- 可以根据实际情况调整发送频率

### 3. 错误处理
- 单个用户发送失败不会影响其他用户
- 发送失败会记录日志，便于排查问题
- 通知状态会更新为"发送失败"（`send_status = 2`）

### 4. 性能优化
- 批量查询用户，减少数据库查询次数
- 分批发送，避免一次性发送过多导致API限流
- 可以根据用户数量调整批量大小

---

## 扩展开发

### 集成短信服务
在 `sendSmsNotification` 方法中替换TODO部分：
```java
// 示例：阿里云短信
SmsClient client = new SmsClient(accessKeyId, accessKeySecret);
SendSmsRequest request = new SendSmsRequest()
    .setPhoneNumbers(user.getPhone())
    .setSignName("智佳鸟类保护区")
    .setTemplateCode("SMS_xxxxx")
    .setTemplateParam("{\"code\":\"" + notification.getContent() + "\"}");
client.sendSms(request);
```

### 集成邮件服务
在 `sendEmailNotification` 方法中替换TODO部分：
```java
// 示例：JavaMail
JavaMailSender mailSender = new JavaMailSenderImpl();
MimeMessage message = mailSender.createMimeMessage();
MimeMessageHelper helper = new MimeMessageHelper(message);
helper.setTo(user.getEmail());
helper.setSubject(notification.getTitle());
helper.setText(notification.getContent(), true);
mailSender.send(message);
```

### 集成微信小程序推送
在 `sendMiniappNotification` 方法中替换TODO部分：
```java
// 示例：微信小程序订阅消息
String accessToken = wechatService.getAccessToken();
String url = "https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=" + accessToken;
Map<String, Object> data = new HashMap<>();
data.put("touser", user.getOpenId());
data.put("template_id", "通知模板ID");
// ... 构建消息数据
httpClient.post(url, data);
```

### 集成微信服务号推送
在 `sendServiceNotification` 方法中替换TODO部分：
```java
// 示例：微信公众号模板消息
String accessToken = wechatService.getAccessToken();
String url = "https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=" + accessToken;
Map<String, Object> data = new HashMap<>();
data.put("touser", user.getOpenId());
data.put("template_id", "通知模板ID");
// ... 构建消息数据
httpClient.post(url, data);
```

---

## 测试建议

1. **创建测试通知**: 在数据库中插入一条测试通知
   ```sql
   INSERT INTO notification(title, content, channel, receiver_type, send_status)
   VALUES('测试通知', '这是一条测试通知', '短信', 'all', 0);
   ```

2. **等待定时任务执行**: 等待5分钟或手动触发定时任务

3. **检查发送结果**: 查看通知表的 `send_status` 和 `send_time` 字段

4. **查看日志**: 检查控制台日志，确认发送过程和结果

---

## 总结

通过定时任务 + 4种发送方式的组合，实现了灵活、可靠的通知发送机制。系统会自动扫描待发送通知，根据通知配置选择合适的发送渠道，批量发送给所有用户或指定用户。

