<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.scenic.mapper.appointment.IndividualReservationMapper">

    <!-- 结果映射 -->
    <resultMap id="IndividualReservationResultMap" type="com.scenic.entity.appointment.IndividualReservation">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="reservation_no" property="reservationNo" jdbcType="VARCHAR"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="scenic_id" property="scenicId" jdbcType="BIGINT"/>
        <result column="visit_date" property="visitDate" jdbcType="DATE"/>
        <result column="time_slot" property="timeSlot" jdbcType="TINYINT"/>
        <result column="adult_count" property="adultCount" jdbcType="INTEGER"/>
        <result column="child_count" property="childCount" jdbcType="INTEGER"/>
        <result column="total_count" property="totalCount" jdbcType="INTEGER"/>
        <result column="status" property="status" jdbcType="TINYINT"/>
        <result column="verification_time" property="verificationTime" jdbcType="TIMESTAMP"/>
        <result column="operator_id" property="operatorId" jdbcType="BIGINT"/>
        <result column="verification_location" property="verificationLocation" jdbcType="VARCHAR"/>
        <result column="device_info" property="deviceInfo" jdbcType="VARCHAR"/>
        <result column="verification_remark" property="verificationRemark" jdbcType="VARCHAR"/>
        <result column="cancel_time" property="cancelTime" jdbcType="TIMESTAMP"/>
        <result column="cancel_reason" property="cancelReason" jdbcType="VARCHAR"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
        <result column="deleted" property="deleted" jdbcType="TINYINT"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="create_by" property="createBy" jdbcType="BIGINT"/>
        <result column="update_by" property="updateBy" jdbcType="BIGINT"/>
        <!-- 主联系人信息 -->
        <result column="contact_name" property="contactName" jdbcType="VARCHAR"/>
        <result column="contact_id_type" property="contactIdType" jdbcType="TINYINT"/>
        <result column="contact_id_number" property="contactIdNumber" jdbcType="VARCHAR"/>
        <result column="contact_phone" property="contactPhone" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 查询字段 -->
    <sql id="IndividualReservation_Column_List">
        id, reservation_no, user_id, scenic_id, visit_date, time_slot, adult_count, child_count, total_count, 
        status, verification_time, operator_id, verification_location, device_info, verification_remark, 
        cancel_time, cancel_reason, version, deleted, create_time, update_time, create_by, update_by
    </sql>

    <!-- 查询所有个人预约（分页，带条件查询） -->
    <select id="selectAll" resultMap="IndividualReservationResultMap">
        SELECT 
        ir.id, ir.reservation_no, ir.user_id, ir.scenic_id, ir.visit_date, ir.time_slot, 
        ir.adult_count, ir.child_count, ir.total_count, ir.status, ir.verification_time, 
        ir.operator_id, ir.verification_location, ir.device_info, ir.verification_remark, 
        ir.cancel_time, ir.cancel_reason, ir.version, ir.deleted, ir.create_time, ir.update_time, 
        ir.create_by, ir.update_by,
        irp.name as contact_name, irp.id_type as contact_id_type, irp.id_number as contact_id_number, irp.phone as contact_phone
        FROM individual_reservation ir
        LEFT JOIN individual_reservation_person irp ON ir.id = irp.reservation_id AND irp.is_contact = 1 AND irp.deleted = 0
        <where>
            ir.deleted = 0
            <if test="applicant != null and applicant != ''">
                AND (ir.reservation_no LIKE CONCAT('%', #{applicant}, '%') 
                     OR irp.name LIKE CONCAT('%', #{applicant}, '%'))
            </if>
            <if test="appointmentTime != null and appointmentTime != ''">
                AND ir.visit_date = DATE(#{appointmentTime})
            </if>
            <if test="phone != null and phone != ''">
                AND (irp.phone LIKE CONCAT('%', #{phone}, '%'))
            </if>
            <if test="status != null">
                AND ir.status = #{status}
            </if>
        </where>
        ORDER BY ir.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询个人预约总数（带条件查询） -->
    <select id="selectCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM individual_reservation ir
        LEFT JOIN individual_reservation_person irp ON ir.id = irp.reservation_id AND irp.is_contact = 1 AND irp.deleted = 0
        <where>
            ir.deleted = 0
            <if test="applicant != null and applicant != ''">
                AND (ir.reservation_no LIKE CONCAT('%', #{applicant}, '%') 
                     OR irp.name LIKE CONCAT('%', #{applicant}, '%'))
            </if>
            <if test="appointmentTime != null and appointmentTime != ''">
                AND ir.visit_date = DATE(#{appointmentTime})
            </if>
            <if test="phone != null and phone != ''">
                AND (irp.phone LIKE CONCAT('%', #{phone}, '%'))
            </if>
            <if test="status != null">
                AND ir.status = #{status}
            </if>
        </where>
    </select>

    <!-- 管理员查询个人预约列表 -->
    <select id="selectForAdmin" resultMap="IndividualReservationResultMap">
        SELECT 
        <include refid="IndividualReservation_Column_List"/>
        FROM individual_reservation
        <where>
            deleted = 0
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="scenicId != null">
                AND scenic_id = #{scenicId}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 管理员查询个人预约总数 -->
    <select id="selectCountForAdmin" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM individual_reservation
        <where>
            deleted = 0
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="scenicId != null">
                AND scenic_id = #{scenicId}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
    </select>

    <!-- 根据证件号码和状态查询个人预约（分页） -->
    <select id="selectByIdNumberAndStatus" resultMap="IndividualReservationResultMap">
        SELECT 
        ir.id, ir.reservation_no, ir.user_id, ir.scenic_id, ir.visit_date, ir.time_slot, 
        ir.adult_count, ir.child_count, ir.total_count, ir.status, ir.verification_time, 
        ir.operator_id, ir.verification_location, ir.device_info, ir.verification_remark, 
        ir.cancel_time, ir.cancel_reason, ir.version, ir.deleted, ir.create_time, ir.update_time, 
        ir.create_by, ir.update_by,
        irp.name as contact_name, irp.id_type as contact_id_type, irp.id_number as contact_id_number, irp.phone as contact_phone
        FROM individual_reservation ir
        LEFT JOIN individual_reservation_person irp ON ir.id = irp.reservation_id AND irp.is_contact = 1 AND irp.deleted = 0
        <where>
            ir.deleted = 0
            AND irp.id_number = #{idNumber}
            <if test="status != null">
                AND ir.status = #{status}
            </if>
        </where>
        ORDER BY ir.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据证件号码和状态查询个人预约总数 -->
    <select id="selectCountByIdNumberAndStatus" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM individual_reservation ir
        LEFT JOIN individual_reservation_person irp ON ir.id = irp.reservation_id AND irp.is_contact = 1 AND irp.deleted = 0
        <where>
            ir.deleted = 0
            AND irp.id_number = #{idNumber}
            <if test="status != null">
                AND ir.status = #{status}
            </if>
        </where>
    </select>

    <!-- 更新个人预约信息（动态更新） -->
    <update id="updateById" parameterType="com.scenic.entity.appointment.IndividualReservation">
        UPDATE individual_reservation
        <set>
            <if test="reservationNo != null and reservationNo != ''">
                reservation_no = #{reservationNo},
            </if>
            <if test="userId != null">
                user_id = #{userId},
            </if>
            <if test="scenicId != null">
                scenic_id = #{scenicId},
            </if>
            <if test="visitDate != null">
                visit_date = #{visitDate},
            </if>
            <if test="timeSlot != null">
                time_slot = #{timeSlot},
            </if>
            <if test="adultCount != null">
                adult_count = #{adultCount},
            </if>
            <if test="childCount != null">
                child_count = #{childCount},
            </if>
            <if test="totalCount != null">
                total_count = #{totalCount},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="verificationTime != null">
                verification_time = #{verificationTime},
            </if>
            <if test="operatorId != null">
                operator_id = #{operatorId},
            </if>
            <if test="verificationLocation != null and verificationLocation != ''">
                verification_location = #{verificationLocation},
            </if>
            <if test="deviceInfo != null and deviceInfo != ''">
                device_info = #{deviceInfo},
            </if>
            <if test="verificationRemark != null and verificationRemark != ''">
                verification_remark = #{verificationRemark},
            </if>
            <if test="cancelTime != null">
                cancel_time = #{cancelTime},
            </if>
            <if test="cancelReason != null and cancelReason != ''">
                cancel_reason = #{cancelReason},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <if test="deleted != null">
                deleted = #{deleted},
            </if>
            update_time = NOW(),
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
        </set>
        WHERE id = #{id}
    </update>
    
    <!-- 批量插入个人预约人员 -->
    <insert id="insertPersonsBatch">
        INSERT INTO individual_reservation_person(reservation_id, name, id_type, id_number, phone, 
            person_type, is_contact, visit_date, time_slot, version, deleted, create_time, update_time, create_by, update_by)
        VALUES
        <foreach collection="persons" item="person" separator=",">
            (#{person.reservationId}, #{person.name}, #{person.idType}, #{person.idNumber}, #{person.phone},
             #{person.personType}, #{person.isContact}, #{person.visitDate}, #{person.timeSlot}, #{person.version},
             #{person.deleted}, #{person.createTime}, #{person.updateTime}, #{person.createBy}, #{person.updateBy})
        </foreach>
    </insert>
    
    <!-- 更新个人预约人员信息 -->
    <update id="updatePersonById" parameterType="com.scenic.entity.appointment.IndividualReservationPerson">
        UPDATE individual_reservation_person
        <set>
            <if test="reservationId != null">
                reservation_id = #{reservationId},
            </if>
            <if test="name != null and name != ''">
                name = #{name},
            </if>
            <if test="idType != null">
                id_type = #{idType},
            </if>
            <if test="idNumber != null and idNumber != ''">
                id_number = #{idNumber},
            </if>
            <if test="phone != null and phone != ''">
                phone = #{phone},
            </if>
            <if test="personType != null">
                person_type = #{personType},
            </if>
            <if test="isContact != null">
                is_contact = #{isContact},
            </if>
            <if test="visitDate != null">
                visit_date = #{visitDate},
            </if>
            <if test="timeSlot != null">
                time_slot = #{timeSlot},
            </if>
            <if test="version != null">
                version = #{version},
            </if>
            <if test="deleted != null">
                deleted = #{deleted},
            </if>
            update_time = NOW(),
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
        </set>
        WHERE id = #{id}
    </update>
    
</mapper>