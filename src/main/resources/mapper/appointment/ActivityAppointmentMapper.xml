<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.scenic.mapper.appointment.ActivityAppointmentMapper">

    <!-- 结果映射 -->
    <resultMap id="ActivityAppointmentResultMap" type="com.scenic.entity.appointment.ActivityAppointment">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="registration_no" property="registrationNo" jdbcType="VARCHAR"/>
        <result column="activity_title" property="activityName" jdbcType="VARCHAR"/>
        <result column="team_name" property="teamName" jdbcType="VARCHAR"/>
        <result column="team_leader" property="contactPerson" jdbcType="VARCHAR"/>
        <result column="contact_phone" property="contactPhone" jdbcType="VARCHAR"/>
        <result column="contact_email" property="contactEmail" jdbcType="VARCHAR"/>
        <result column="activity_id" property="activityId" jdbcType="BIGINT"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="form_file_id" property="formFileId" jdbcType="BIGINT"/>
        <result column="registration_time" property="activityDate" jdbcType="TIMESTAMP"/>
        <result column="activity_time" property="activityTime" jdbcType="VARCHAR"/>
        <result column="team_size" property="numberOfPeople" jdbcType="INTEGER"/>
        <result column="remarks" property="remark" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="create_by" property="createBy" jdbcType="BIGINT"/>
    </resultMap>

    <!-- 活动预约结果映射（包含团队成员） -->
    <resultMap id="ActivityAppointmentWithMembersResultMap" type="com.scenic.entity.appointment.ActivityAppointment">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="registration_no" property="registrationNo" jdbcType="VARCHAR"/>
        <result column="activity_title" property="activityName" jdbcType="VARCHAR"/>
        <result column="team_name" property="teamName" jdbcType="VARCHAR"/>
        <result column="team_leader" property="contactPerson" jdbcType="VARCHAR"/>
        <result column="contact_phone" property="contactPhone" jdbcType="VARCHAR"/>
        <result column="contact_email" property="contactEmail" jdbcType="VARCHAR"/>
        <result column="activity_id" property="activityId" jdbcType="BIGINT"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="form_file_id" property="formFileId" jdbcType="BIGINT"/>
        <result column="registration_time" property="activityDate" jdbcType="TIMESTAMP"/>
        <result column="activity_time" property="activityTime" jdbcType="VARCHAR"/>
        <result column="team_size" property="numberOfPeople" jdbcType="INTEGER"/>
        <result column="remarks" property="remark" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="create_by" property="createBy" jdbcType="BIGINT"/>
        <collection property="members" ofType="com.scenic.entity.appointment.TeamMember">
            <id column="member_id" property="id" jdbcType="BIGINT"/>
            <result column="team_appointment_id" property="teamAppointmentId" jdbcType="BIGINT"/>
            <result column="name" property="name" jdbcType="VARCHAR"/>
            <result column="id_card" property="idCard" jdbcType="VARCHAR"/>
            <result column="phone" property="phone" jdbcType="VARCHAR"/>
            <result column="age" property="age" jdbcType="INTEGER"/>
            <result column="gender" property="gender" jdbcType="VARCHAR"/>
            <result column="remark" property="remark" jdbcType="VARCHAR"/>
            <result column="member_create_time" property="createTime" jdbcType="TIMESTAMP"/>
            <result column="member_update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        </collection>
    </resultMap>

    <!-- 查询字段 -->
    <sql id="ActivityAppointment_Column_List">
        id, registration_no, activity_title, team_name, team_leader, contact_phone, contact_email, activity_id, user_id, form_file_id,
        registration_time, activity_time, team_size, remarks, status, create_time, update_time, create_by
    </sql>

    <!-- 查询活动预约列表 -->
    <select id="selectList" resultMap="ActivityAppointmentResultMap">
        SELECT 
        <include refid="ActivityAppointment_Column_List"/>
        FROM activity_registration
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询活动预约总数 -->
    <select id="selectCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM activity_registration
    </select>

    <!-- 管理员查询活动预约列表 -->
    <select id="selectForAdmin" resultMap="ActivityAppointmentResultMap">
        SELECT 
        <include refid="ActivityAppointment_Column_List"/>
        FROM activity_registration
        <where>
            <if test="activityName != null and activityName != ''">
                activity_title LIKE CONCAT('%', #{activityName}, '%')
            </if>
            <if test="teamName != null and teamName != ''">
                AND team_name LIKE CONCAT('%', #{teamName}, '%')
            </if>
            <if test="contactPerson != null and contactPerson != ''">
                AND team_leader LIKE CONCAT('%', #{contactPerson}, '%')
            </if>
            <if test="contactPhone != null and contactPhone != ''">
                AND contact_phone LIKE CONCAT('%', #{contactPhone}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="startTime != null and startTime != ''">
                AND registration_time <![CDATA[>=]]> #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND registration_time <![CDATA[<=]]> #{endTime}
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 管理员查询活动预约总数 -->
    <select id="selectCountForAdmin" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM activity_registration
        <where>
            <if test="activityName != null and activityName != ''">
                activity_title LIKE CONCAT('%', #{activityName}, '%')
            </if>
            <if test="teamName != null and teamName != ''">
                AND team_name LIKE CONCAT('%', #{teamName}, '%')
            </if>
            <if test="contactPerson != null and contactPerson != ''">
                AND team_leader LIKE CONCAT('%', #{contactPerson}, '%')
            </if>
            <if test="contactPhone != null and contactPhone != ''">
                AND contact_phone LIKE CONCAT('%', #{contactPhone}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="startTime != null and startTime != ''">
                AND registration_time <![CDATA[>=]]> #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND registration_time <![CDATA[<=]]> #{endTime}
            </if>
        </where>
    </select>
    
    <!-- 根据ID查询活动预约 -->
    <select id="selectById" resultMap="ActivityAppointmentResultMap" parameterType="java.lang.Long">
        SELECT 
        <include refid="ActivityAppointment_Column_List"/>
        FROM activity_registration
        WHERE id = #{id}
    </select>
    
    <!-- 插入活动预约 -->
    <insert id="insert" parameterType="com.scenic.entity.appointment.ActivityAppointment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO activity_registration(
            registration_no, activity_title, team_name, team_leader, contact_phone, contact_email, activity_id, user_id, form_file_id,
            registration_time, activity_time, team_size, remarks, status, create_time, update_time, create_by
        ) VALUES(
            #{registrationNo, jdbcType=VARCHAR}, #{activityName, jdbcType=VARCHAR}, #{teamName, jdbcType=VARCHAR}, #{contactPerson, jdbcType=VARCHAR}, #{contactPhone, jdbcType=VARCHAR}, #{contactEmail, jdbcType=VARCHAR}, #{activityId, jdbcType=BIGINT}, #{userId, jdbcType=BIGINT}, #{formFileId, jdbcType=BIGINT},
            #{activityDate, jdbcType=TIMESTAMP}, #{activityTime, jdbcType=VARCHAR}, #{numberOfPeople, jdbcType=INTEGER}, #{remark, jdbcType=VARCHAR}, #{status, jdbcType=INTEGER}, #{createTime, jdbcType=TIMESTAMP}, #{updateTime, jdbcType=TIMESTAMP}, #{createBy, jdbcType=BIGINT}
        )
    </insert>
    
    <!-- 更新活动预约信息 -->
    <update id="updateById" parameterType="com.scenic.entity.appointment.ActivityAppointment">
        UPDATE activity_registration
        <set>
            <if test="activityName != null and activityName != ''">
                activity_title = #{activityName},
            </if>
            <if test="teamName != null and teamName != ''">
                team_name = #{teamName},
            </if>
            <if test="contactPerson != null and contactPerson != ''">
                team_leader = #{contactPerson},
            </if>
            <if test="contactPhone != null and contactPhone != ''">
                contact_phone = #{contactPhone},
            </if>
            <if test="contactEmail != null and contactEmail != ''">
                contact_email = #{contactEmail},
            </if>
            <if test="activityId != null">
                activity_id = #{activityId},
            </if>
            <if test="activityDate != null">
                registration_time = #{activityDate},
            </if>
            <if test="activityTime != null and activityTime != ''">
                activity_time = #{activityTime},
            </if>
            <if test="numberOfPeople != null">
                team_size = #{numberOfPeople},
            </if>
            <if test="remark != null and remark != ''">
                remarks = #{remark},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            update_time = #{updateTime}
        </set>
        WHERE id = #{id}
    </update>
    
    <!-- 根据ID删除活动预约 -->
    <delete id="deleteById" parameterType="java.lang.Long">
        DELETE FROM activity_registration WHERE id = #{id}
    </delete>
    
    <!-- 根据ID查询活动预约（包含团队成员信息） -->
    <select id="selectByIdWithMembers" resultMap="ActivityAppointmentWithMembersResultMap">
        SELECT 
        ar.id,
        ar.registration_no,
        ar.activity_title,
        ar.team_name,
        ar.team_leader,
        ar.contact_phone,
        ar.contact_email,
        ar.activity_id,
        ar.user_id,
        ar.form_file_id,
        ar.registration_time,
        ar.activity_time,
        ar.team_size,
        ar.remarks,
        ar.status,
        ar.create_time,
        ar.update_time,
        ar.create_by,
        tm.id AS member_id,
        tm.team_appointment_id,
        tm.name,
        tm.id_card,
        tm.phone,
        tm.age,
        tm.gender,
        tm.remark,
        tm.create_time AS member_create_time,
        tm.update_time AS member_update_time
        FROM activity_registration ar
        LEFT JOIN team_member tm ON ar.id = tm.team_appointment_id
        WHERE ar.id = #{id}
    </select>
</mapper>
